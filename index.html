<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0"
    />
    <title>Value driver tree demo</title>
  </head>
  <body>
    <header style="display: none">
      <h1>Value driver tree demo</h1>
      <nav>
        <button id="btnEdit">Edit</button>
        <button id="btnTree" class="selected">Tree</button>
        <button id="btnList">List</button>
      </nav>
    </header>
    <main>
      <div id="editor-container" style="display: none">
        <div class="editor" contenteditable="true" id="editTextArea">Hello</div>
        <div class="error" id="error-message"></div>
        <button id="btnUpdate">Update</button>
      </div>
      <div id="tree-container" style="display: grid"></div>
      <div id="list-container" style="display: none"></div>
    </main>
    <script type="module">
      import { nodeToText, updateList, updateTree } from "/src/nodes.ts";
      import { ParseVDT } from "/src/parser.ts";
      const editContainer = document.getElementById("editor-container");
      const treeContainer = document.getElementById("tree-container");
      const listContainer = document.getElementById("list-container");
      const editTextArea = document.getElementById("editTextArea");
      const btnEdit = document.getElementById("btnEdit");
      const btnTree = document.getElementById("btnTree");
      const btnList = document.getElementById("btnList");
      const btnUpdate = document.getElementById("btnUpdate");
      const errorMessage = document.getElementById("error-message");

      // Setup with query parameters
      const urlParams = new URLSearchParams(window.location.search);
      const view = urlParams.get("v");
      const password = urlParams.get("p");
      console.log(view);
      console.log(window.location.search);
      switch (view) {
        case "tree":
          break;
        case "list":
          showList();
          break;
        default:
          document.querySelector("header").style.display = "block";
          document.querySelector("main").classList.add("bordered");
          break;
      }

      let parsed = "";
      let treeEq = `Sales = Volume * Price\nVolume = [100]\nPrice = [3.50]`;
      try {
        parsed = ParseVDT(`<%= tree_text %>`);
        treeEq = nodeToText(parsed);
        editTextArea.innerText = treeEq;
      } catch (error) {
        console.error(error);
        editTextArea.innerText = treeEq;
      }

      function showEditor() {
        editContainer.style.display = "block";
        treeContainer.style.display = "none";
        listContainer.style.display = "none";
        btnEdit.classList.add("selected");
        btnTree.classList.remove("selected");
        btnList.classList.remove("selected");
      }
      function showTree() {
        editContainer.style.display = "none";
        treeContainer.style.display = "grid";
        listContainer.style.display = "none";
        btnEdit.classList.remove("selected");
        btnTree.classList.add("selected");
        btnList.classList.remove("selected");
      }
      function showList() {
        editContainer.style.display = "none";
        treeContainer.style.display = "none";
        listContainer.style.display = "grid";
        btnEdit.classList.remove("selected");
        btnTree.classList.remove("selected");
        btnList.classList.add("selected");
      }
      function parseTree() {
        try {
          const newTree = ParseVDT(editTextArea.innerText);
          updateTree(newTree, treeContainer);
          updateList(newTree, listContainer);
          errorMessage.innerHTML = "";
        } catch (error) {
          errorMessage.innerHTML = error;
        }
      }
      btnEdit.addEventListener("click", showEditor);
      btnTree.addEventListener("click", showTree);
      btnList.addEventListener("click", showList);
      btnUpdate.addEventListener("click", parseTree);
      parseTree();
      try {
        const initialTree = ParseVDT(treeEq);
        updateTree(initialTree, treeContainer);
        updateList(initialTree, listContainer);
        errorMessage.innerHTML = "";
      } catch (error) {
        console.error(error);
        errorMessage.innerHTML = error;
      }

      //updateTree(parsed, treeContainer);
      //updateList(parsed, listContainer);
    </script>
  </body>
</html>
